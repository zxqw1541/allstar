<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<link type="text/css" rel="stylesheet" href="css/header_footer.css" />
<link rel="stylesheet" type="text/css" href="css/normalize.css" />
<link rel="stylesheet" type="text/css" href="css/component.css" />
<link rel="stylesheet" type="text/css" href="css/competition.css" />
<link rel='stylesheet' type='text/css' href='../lib/jquery-bracket/jquery.bracket.min.css'/>


<!-- <link rel="stylesheet" href="css/tos/tos.css" /> -->
<link rel="stylesheet" type="text/css" href="css/competitionDetail.css" />
<link rel="Shortcut Icon" href="http://s.nx.com/s2/game/tos/common/farvicon.ico" type="image/x-icon" />
<link rel="icon" href="http://s.nx.com/s2/game/tos/common/farvicon.ico" type="image/x-icon" />

<script src="js/jquery-1.11.3.js"></script>

<script src="js/modernizr.min.js"></script>

</head>
<body>
<div id="header"></div>
<div style="height:100px;"></div>

<div id="container">
	<div id="contents" style='background-color: white; width: 1258px; margin: auto; overflow: auto;'>
		<div class="viewWrap boardContents boardView"
			style="width: 100%; overflow-y: auto;">
			<article id="subject" class="mainArea">

        
      </article>
			<aside id="rightSide" class="sideArea">
			  <h3 class='blind'>참여 정보</h3>
			  <div class='info clearFix'>
				  <h2>참여 정보</h2>
				  <div class='contents'>
				    <span id='thumLeftBtn'></span>
				    <span id='thumRightBtn'></span>
				    <p class='img'>
				    <p class='img'>
				    <p class='img'>
				    <p class='img'>
			    </div>
			    <!-- 팀명 보여줌 -->
			    <div class='teamName'><h2></h2></div>
			  </div>
			  <div class='btnArea'>
			    <p class='btnHome'><a href='#' id='btnArticleJoin' style='margin-left:0%; margin-bottom:34px' class='btn btnType5'>참여하기</a></p>
			    <div class="btm clearFix">
            <a href="#" id="btnArticleWrite" class="btn btnType6 btnWrite" style='margin-left:0%'>글쓰기</a>
            <a href="#" id="btnArticleList" class="btn btnType6 btnList" style='margin-left:0%'>목록</a>
          </div>
			    
        </div>
			  <p class='btnHome'><a href='#' id='btnArticleJoin2' style='margin-left:0%; margin-bottom:34px' class='btn btnType5'>강제참여</a></p>
			</aside>
		</div>
	</div>
</div>

<div id="footer"></div>

<!-- 기본 정보 출력 -->
<script type='text/javascript' src='../lib/jquery-bracket/jquery.bracket.min.js'></script>
<script>
var no = -1;
if (location.href.indexOf('?') != -1)
  no = location.href.split('?')[1].split('=')[1];
var status = '모집예정'
$.getJSON('/allstar/competition/detail.do?no=' + no, function(resultObj) {
  var ajaxResult = resultObj.ajaxResult;
    if (ajaxResult.status == "success") {
      var c = ajaxResult.data;
      var rsd = new Date(c.recruitStartDate).getTime();
      var red = new Date(c.recruitEndDate).getTime();
      var sd = new Date(c.startDate).getTime();
      var ed = new Date(c.endDate).getTime();
      var nowd = new Date().getTime();

      if (rsd < nowd && nowd < red) {
        status = '모집중';
      } else if (red < nowd && nowd < sd){
        status = '대회준비중';
      } else if (sd < nowd && nowd < ed) {
        status = '대회중';
      } else if (ed < nowd) {
        status = '대회종료';
      }
      
      var sub_article = $("#subject")
      var detail =
          "<header id='test1'class='header'  style='height:90px'>"
          + "<div class='inner clearFix'>"
          + "  <div class='subject'>"
          + "    <h2 class='tit'>" + c.name  + "</h2>"
          + "    <p class='etc'><span class='date'>모집기간 : " + c.recruitStartDate + " ~ " + c.recruitEndDate 
          +        "<br>대회시작 : " + c.startDate 
          + "       <br>참가비 : " + c.cost + "원</span></p>"
          + "  </div>"
          + "  <p class='cnt'>"
          + "  <span class='view'><strong>" + status + "</strong></span></p>"
          + "</div>"
          + "</header>"
          + "<div id='test2' class='viewContents'>"
          + "  <img src='../competition/img/" + c.poster + "'>"
          + "  <pre>" + c.content + "</pre>"
          + "  <h2> 대진표</h2>"
          + "  <div id='minimal'>"
          + "    <div class='demo'></div>"
          + "  </div>"      
          + "  <h2> 장소</h2>"
          + "  <div class='div_left_map'>"
          + "  <iframe src='https://www.google.com/maps/d/embed?mid=zouJJd1kxH7U.kb2sjmzfDunA' width='750px' height='600px' ></iframe>"
          + "  </div>"
          + "</div>";
      sub_article.append(detail);
      

          console.log($('#minimal .demo'));
          $('#minimal .demo').bracket({init: JSON.parse(c.operation) });
      
    }
  });
</script>

<!-- 참여한 팀 섬네일 출력 -->
<script>
$.getJSON('/allstar/competition/imglist.do?cno=' + no, function(resultObj) {
	var ajaxResult = resultObj.ajaxResult;
	if (ajaxResult.status == "success") {
		var teamList = ajaxResult.data;

		changeThumb(teamList, 0);
 		nextThumb(teamList, Math.ceil(teamList.length/4));
	} else if (ajaxResult.status == "empty") {
		console.log("empty");
		emptyThumb();
	}
});

function emptyThumb() {
	$(".img").each(function(index, item) {
	    $(this).children().remove();
	    var path = '../team/img/invisible_team.png';
      $("<img>").attr({ 
        src : path
      }).appendTo($(this));
	  });
	$('.teamName h2').text('참가한 팀이 없습니다.');
}

/* 그림 넣기 */
function changeThumb(teamList, page) {
	$(".img").each(function(index, item) {
		$(this).children().remove();
		var path='../team/img/tcd_file-1453879458179-1.png';
		if (page*4 + index*1 >= teamList.length) {
			path = '../team/img/invisible_team.png';
		}
		else if (teamList[page*4+index].emblem != null)
			path = '../team/img/tcd_' + teamList[page*4+index].emblem;

	    $("<img>").attr({
	    	class : 'team_img',
	    	teamno : page*4 + index, 
			  src : path
		  }).appendTo($(this));
	});
	imgMouseEvent(teamList);
	
}
/* < , >  */
function nextThumb(teamList, si){
	var i = 0;
	$("#thumLeftBtn").click(function(event) {
		  i--;
		  if(i < 0) {
			  i = si-1;
		  }
		  changeThumb(teamList, i);
	});
	
	$("#thumRightBtn").click(function(event) {
    i++;
    if(i == si) {
      i = 0;
    }
    changeThumb(teamList, i);
	});
}

function imgMouseEvent(teamList) {
	$('.team_img').mouseenter(function(){
		var i = $(this).attr('teamno');
		if (teamList.length <= i)
			$('.teamName h2').text('');
		else
			$('.teamName h2').text(teamList[i].name)
  });
  $('.team_img').mouseout(function(){
	  $('.teamName h2').text('')
  });
}

</script>

<!-- 참가하기 버튼 리스너 -->
<script>
$('#btnArticleJoin').on('click', function(event){
    event.preventDefault();
    alert('참여하기버튼');
  });
</script>
<!-- 수정 삭제 버튼 추가(해당 글쓴이만!, 지금은 모두에게 보여주는것으로 구현 -->
<script>
var div = $('.btnArea');
$('<div>').addClass('btm clearFix')
  .html(
		  "<a href='#' id='btnArticleUpdate' class='btn btnType6 btnWrite' style='margin-left:0%'>글수정</a>"
    + "<a href='#' id='btnArticleRemove' class='btn btnType6 btnList' style='margin-left:0%'>글삭제</a>"
		  ).appendTo(div);
</script>

<!-- 수정 버튼 리스너 -->
<script>
$('#btnArticleUpdate').on('click', function(event){
    event.preventDefault();
    if (status != '모집예정') {
    	alert('모집 전에만 수정할 수 있습니다!');
    	return;
    }
    location.href = "competitionForm.html?no=" + no;
    
  });
</script>

<!-- 삭제 버튼 리스너 -->
<script>
$('#btnArticleRemove').on('click', function(event){
	  event.preventDefault();
	  $.getJSON('/allstar/competition/delete.do?no=' + no, function(resultObj) {
		  var ajaxResult = resultObj.ajaxResult;
		    if (ajaxResult.status == "success") {
		    	alert('삭제 성공!');
		    	location.href = 'competitionList.html';
		    } else {
		    	alert('삭제 실패!');	
		    }
		  });
	});
</script>

<!-- 목록 버튼 리스너-->
<script>
$('#btnArticleList').on('click', function(event){
  event.preventDefault();
  location.href="competitionList.html";
  /* history.go(-1); */
});
</script>

<!-- 새글 버튼 리스너-->
<script>
$('#btnArticleWrite').on('click', function(event){
	event.preventDefault();
  alert('새글버튼');
  location.href = 'competitionForm.html?no=-1';  
});
</script>

<script>
$(function(){
  
    $("#header").load("header.html"); 
    $("#footer").load("footer.html"); 
  });
</script>

<!-- 강제 참여 리스너 -->
<script>
/* 일단 강제 */
var tno = 100;
$('#btnArticleJoin2').on('click', function(event){
    event.preventDefault();

    console.log(no);
    console.log(tno);
    
    $.ajax({
        url : "../competition/joinc.do?cno="+ no +"&tno="+tno,
        type : "GET",
        dataType: "json",
        processData: false, 
        contentType:false,
        success : function(result) {
        	if (result.ajaxResult.status == "success") {
        		tno--;
            alert("참가 성공");
          } else if (result.ajaxResult.status == "already") {
        	  tno--;
            alert("이미참가");
          } else {
        	  alert("?????")
          }
        },
		    error : function(result){
		      alert('error');
		    }
    });
});
</script>


</body>
</html>